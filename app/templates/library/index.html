{% extends 'base.html' %}

{% block title %}Library — ABS Request Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">
    <i class="bi bi-collection me-2"></i>Audiobook Library
  </h2>
</div>

{% if not abs_configured %}
<!-- ── ABS not configured ─────────────────────────────────────────────────── -->
<div class="alert alert-info d-flex align-items-start gap-2" role="alert">
  <i class="bi bi-info-circle-fill fs-5 flex-shrink-0 mt-1"></i>
  <div>
    <strong>Audiobookshelf is not configured.</strong>
    The library browser is unavailable. Contact your manager to set up the
    Audiobookshelf connection.
  </div>
</div>

{% else %}
<!-- ── Library selector tabs ─────────────────────────────────────────────── -->
{% if libraries|length > 1 %}
<ul class="nav nav-tabs mb-3">
  {% for lib in libraries %}
  <li class="nav-item">
    <a
      class="nav-link {% if lib.id == selected_library_id %}active{% endif %}"
      href="{{ url_for('library.index', library_id=lib.id) }}"
    >
      <i class="bi bi-collection me-1"></i>{{ lib.name }}
    </a>
  </li>
  {% endfor %}
</ul>
{% elif libraries|length == 1 %}
<h5 class="mb-3 text-muted fw-normal">
  <i class="bi bi-collection me-1"></i>{{ libraries[0].name }}
</h5>
{% endif %}

<!-- ── Search bar ────────────────────────────────────────────────────────── -->
<form
  action="{{ url_for('library.index') }}"
  method="GET"
  class="mb-3 d-flex gap-2"
>
  {% if selected_library_id %}
  <input type="hidden" name="library_id" value="{{ selected_library_id }}">
  {% endif %}
  <div class="input-group">
    <input
      type="text"
      name="q"
      value="{{ query }}"
      class="form-control"
      placeholder="Filter by title or author…"
      aria-label="Search library"
    >
    <button class="btn btn-outline-secondary" type="submit">
      <i class="bi bi-search"></i>
    </button>
    {% if query %}
    <a
      href="{{ url_for('library.index', library_id=selected_library_id) }}"
      class="btn btn-outline-secondary"
      title="Clear search"
    >
      <i class="bi bi-x"></i>
    </a>
    {% endif %}
  </div>
</form>

<!-- ── Results count ──────────────────────────────────────────────────────── -->
<p class="text-muted small mb-3">
  {% if query %}
    {{ total }} result{{ 's' if total != 1 else '' }} for &ldquo;<em>{{ query }}</em>&rdquo;
  {% else %}
    {{ total }} audiobook{{ 's' if total != 1 else '' }}
  {% endif %}
  {% if pages > 1 %}
  &nbsp;&mdash;&nbsp;page {{ page }} of {{ pages }}
  {% endif %}
</p>

{% if items %}
<!-- ── Card grid ─────────────────────────────────────────────────────────── -->
<div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4 mb-4">
  {% for item in items %}
  <div class="col">
    <div class="card h-100 shadow-sm">

      <!-- Cover -->
      <div style="height: 200px; overflow: hidden; background: #f0f0f0;">
        {% if item.cover_url %}
        <img
          src="{{ item.cover_url }}"
          alt="{{ item.title }}"
          class="w-100 h-100"
          style="object-fit: cover;"
          loading="lazy"
          onerror="this.parentElement.innerHTML='<div class=\'w-100 h-100 d-flex align-items-center justify-content-center bg-secondary text-white\'><i class=\'bi bi-book display-4\'></i></div>'"
        >
        {% else %}
        <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-secondary text-white">
          <i class="bi bi-book display-4"></i>
        </div>
        {% endif %}
      </div>

      <div class="card-body d-flex flex-column">
        <h6 class="card-title fw-bold mb-1">{{ item.title }}</h6>

        {% if item.author %}
        <p class="text-muted small mb-1">
          <i class="bi bi-person me-1"></i>{{ item.author }}
        </p>
        {% endif %}

        {% if item.narrator %}
        <p class="text-muted small mb-1">
          <i class="bi bi-mic me-1"></i>{{ item.narrator }}
        </p>
        {% endif %}

        <div class="mt-auto pt-2 d-flex flex-wrap gap-1">
          {% if item.duration %}
          <span class="badge text-bg-secondary">
            <i class="bi bi-clock me-1"></i>{{ item.duration }}
          </span>
          {% endif %}
          {% if item.library_name %}
          <span class="badge text-bg-light text-dark border">{{ item.library_name }}</span>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
  {% endfor %}
</div>

<!-- ── Pagination ──────────────────────────────────────────────────────────── -->
{% if pages > 1 %}
<nav aria-label="Library pagination">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
      <a
        class="page-link"
        href="{{ url_for('library.index', library_id=selected_library_id, q=query, page=page-1) }}"
        aria-label="Previous"
      >
        <i class="bi bi-chevron-left"></i>
      </a>
    </li>

    {% set start_page = [1, page - 2] | max %}
    {% set end_page   = [pages, page + 2] | min %}

    {% if start_page > 1 %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('library.index', library_id=selected_library_id, q=query, page=1) }}">1</a>
    </li>
    {% if start_page > 2 %}
    <li class="page-item disabled"><span class="page-link">…</span></li>
    {% endif %}
    {% endif %}

    {% for p in range(start_page, end_page + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a
        class="page-link"
        href="{{ url_for('library.index', library_id=selected_library_id, q=query, page=p) }}"
      >{{ p }}</a>
    </li>
    {% endfor %}

    {% if end_page < pages %}
    {% if end_page < pages - 1 %}
    <li class="page-item disabled"><span class="page-link">…</span></li>
    {% endif %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('library.index', library_id=selected_library_id, q=query, page=pages) }}">{{ pages }}</a>
    </li>
    {% endif %}

    <li class="page-item {% if page >= pages %}disabled{% endif %}">
      <a
        class="page-link"
        href="{{ url_for('library.index', library_id=selected_library_id, q=query, page=page+1) }}"
        aria-label="Next"
      >
        <i class="bi bi-chevron-right"></i>
      </a>
    </li>
  </ul>
</nav>
{% endif %}

{% else %}
<!-- ── Empty state ────────────────────────────────────────────────────────── -->
<div class="text-center text-muted py-5 border rounded">
  <i class="bi bi-collection display-4 d-block mb-3"></i>
  {% if query %}
  <p class="lead mb-1">No items match &ldquo;<em>{{ query }}</em>&rdquo;</p>
  <p class="small mb-3">Try a different search term.</p>
  <a href="{{ url_for('library.index', library_id=selected_library_id) }}" class="btn btn-outline-secondary btn-sm">
    Clear search
  </a>
  {% else %}
  <p class="lead mb-1">No audiobooks found in this library.</p>
  <p class="small">The library may be empty or still syncing.</p>
  {% endif %}
</div>
{% endif %}

{% endif %}{# abs_configured #}
{% endblock %}
