{% extends 'base.html' %}

{% block title %}Search — ABS Request Manager{% endblock %}

{# ── Macro: render a results grid + pagination for one provider ──────────────── #}
{% macro result_cards(pdata, query, page, author_search, narrator_search, tab, provider_filter) %}

<p class="text-muted mb-3">
  <strong>{{ pdata.total if pdata.total else pdata.results|length }}</strong>
  result{{ 's' if pdata.total != 1 and pdata.results|length != 1 else '' }} for
  &ldquo;<em>{{ query }}</em>&rdquo;
</p>

<div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
  {% for result in pdata.results %}
  <div class="col">
    <div class="card h-100 shadow-sm">

      <!-- Cover image -->
      <div style="aspect-ratio: 1/1; overflow: hidden; background: #f0f0f0;">
        {% if result.cover_url %}
        <img
          src="{{ result.cover_url }}"
          alt="{{ result.title }}"
          class="w-100 h-100"
          style="object-fit: cover;"
        >
        {% else %}
        <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-secondary text-white">
          <i class="bi bi-book display-4"></i>
        </div>
        {% endif %}
      </div>

      <div class="card-body d-flex flex-column">
        <!-- Title & Author -->
        <h6 class="card-title fw-bold mb-1">{{ result.title }}</h6>
        {% if result.author %}
        <p class="text-muted small mb-1">
          <i class="bi bi-person me-1"></i>{% for name in result.author.split(',') %}{% set n = name.strip() %}{% if not loop.first %}, {% endif %}{% if result.source == 'audible' %}<a href="{{ url_for('main.search', q=n, author_search=1) }}" class="text-muted">{{ n }}</a>{% else %}<a href="{{ url_for('main.search', q=n, provider=result.source) }}" class="text-muted">{{ n }}</a>{% endif %}{% endfor %}
        </p>
        {% endif %}
        {% if result.narrator %}
        <p class="text-muted small mb-1">
          <i class="bi bi-mic me-1"></i>Narrated by {% for name in result.narrator.split(',') %}{% set n = name.strip() %}{% if not loop.first %}, {% endif %}{% if result.source == 'audible' %}<a href="{{ url_for('main.search', q=n, narrator_search=1) }}" class="text-muted">{{ n }}</a>{% else %}<a href="{{ url_for('main.search', q=n, provider=result.source) }}" class="text-muted">{{ n }}</a>{% endif %}{% endfor %}
        </p>
        {% endif %}

        <!-- Description (truncated) -->
        {% if result.description %}
        <p class="card-text small text-muted mt-1 mb-2" style="flex: 1;">
          {{ result.description | truncate(120) }}
        </p>
        {% else %}
        <div style="flex: 1;"></div>
        {% endif %}

        <!-- Badges -->
        <div class="d-flex flex-wrap gap-1 mb-2">
          {% if result.source == 'audible' %}
          <span class="badge text-bg-warning text-dark">Audible</span>
          {% elif result.source == 'storytel' %}
          <span class="badge text-bg-info text-dark">Storytel</span>
          {% elif result.source == 'open_library' %}
          <span class="badge text-bg-secondary">Open Library</span>
          {% endif %}

          {% if result.abs_match %}
          {% set match_body %}{{ result.abs_match_title }}{% if result.abs_match_author %} &mdash; {{ result.abs_match_author }}{% endif %}{% endset %}
          {% if result.abs_match_certain %}
          <span
            class="badge text-bg-danger"
            role="button"
            tabindex="0"
            data-bs-toggle="popover"
            data-bs-trigger="click"
            data-bs-placement="top"
            data-bs-title="Found in ABS library"
            data-bs-content="{{ match_body }}"
          >
            <i class="bi bi-exclamation-triangle-fill me-1"></i>In Library
          </span>
          {% else %}
          <span
            class="badge text-bg-warning text-dark"
            role="button"
            tabindex="0"
            data-bs-toggle="popover"
            data-bs-trigger="click"
            data-bs-placement="top"
            data-bs-title="Possible match in ABS library"
            data-bs-content="{{ match_body }}"
          >
            <i class="bi bi-question-circle me-1"></i>Possibly in Library
          </span>
          {% endif %}
          {% endif %}
        </div>

        <!-- Action button -->
        {% if result.already_requested %}
        <button class="btn btn-outline-secondary btn-sm w-100" disabled>
          <i class="bi bi-check-circle me-1"></i>Already Requested
        </button>
        {% else %}
        {% set req_url = url_for('main.request_new',
            title=result.title,
            author=result.author or '',
            narrator=result.narrator or '',
            cover_url=result.cover_url or '',
            isbn=result.isbn or '',
            asin=result.asin or '',
            google_books_id=result.google_books_id or '',
            duration=result.duration or '',
            description=result.description or '',
            source=result.source or '') %}
        <a href="{{ req_url }}" class="btn btn-primary btn-sm w-100">
          <i class="bi bi-plus-circle me-1"></i>Request this book
        </a>
        {% endif %}

      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Pagination (only for providers that support it, i.e. Audible) -->
{% if pdata.total_pages and pdata.total_pages > 1 %}
<nav class="mt-4 d-flex justify-content-between align-items-center">
  {% if page > 1 %}
  <a
    href="{{ url_for('main.search', q=query, page=page-1, tab=tab if tab else None, provider=provider_filter if provider_filter else None, author_search=1 if author_search else None, narrator_search=1 if narrator_search else None) }}"
    class="btn btn-outline-secondary"
  >
    <i class="bi bi-chevron-left me-1"></i>Previous
  </a>
  {% else %}
  <span></span>
  {% endif %}

  <span class="text-muted small">Page {{ page }} of {{ pdata.total_pages }}</span>

  {% if page < pdata.total_pages %}
  <a
    href="{{ url_for('main.search', q=query, page=page+1, tab=tab if tab else None, provider=provider_filter if provider_filter else None, author_search=1 if author_search else None, narrator_search=1 if narrator_search else None) }}"
    class="btn btn-outline-secondary"
  >
    Next<i class="bi bi-chevron-right ms-1"></i>
  </a>
  {% else %}
  <span></span>
  {% endif %}
</nav>
{% endif %}

{% endmacro %}


{% block content %}

<!-- ── Search bar ────────────────────────────────────────────────────────────── -->
<form action="{{ url_for('main.search') }}" method="GET" class="mb-4">
  <div class="input-group">
    <input
      type="text"
      name="q"
      value="{{ query }}"
      class="form-control form-control-lg"
      placeholder="Search by title, author, or ISBN…"
      aria-label="Search"
    >
    <button class="btn btn-primary btn-lg" type="submit">
      <i class="bi bi-search me-1"></i>Search
    </button>
  </div>
</form>

{% if provider_data %}

<!-- ── Search mode banners ────────────────────────────────────────────────────── -->
{% if author_search %}
<div class="alert alert-secondary d-flex align-items-center gap-2 mb-3" role="alert">
  <i class="bi bi-person-fill flex-shrink-0"></i>
  <span>
    Showing Audible books by author <strong>{{ query }}</strong>.
    <a href="{{ url_for('main.search', q=query) }}" class="alert-link ms-1">Search all providers instead</a>
  </span>
</div>
{% elif narrator_search %}
<div class="alert alert-secondary d-flex align-items-center gap-2 mb-3" role="alert">
  <i class="bi bi-mic-fill flex-shrink-0"></i>
  <span>
    Showing Audible books narrated by <strong>{{ query }}</strong>.
    <a href="{{ url_for('main.search', q=query) }}" class="alert-link ms-1">Search all providers instead</a>
  </span>
</div>
{% elif provider_filter %}
<div class="alert alert-secondary d-flex align-items-center gap-2 mb-3" role="alert">
  <i class="bi bi-funnel-fill flex-shrink-0"></i>
  <span>
    Showing <strong>{{ provider_filter | replace('_', ' ') | title }}</strong> results for <strong>{{ query }}</strong>.
    <a href="{{ url_for('main.search', q=query) }}" class="alert-link ms-1">Search all providers instead</a>
  </span>
</div>
{% endif %}

{% if any_certain_match %}
<div class="alert alert-warning d-flex align-items-center gap-2 mb-3" role="alert">
  <i class="bi bi-exclamation-triangle-fill flex-shrink-0"></i>
  Some results may already be in your Audiobookshelf library. Check before requesting.
</div>
{% endif %}

{% if provider_data|length > 1 %}

<!-- ── Multi-provider tabs ────────────────────────────────────────────────────── -->
<ul class="nav nav-tabs mb-4" id="providerTabs" role="tablist">
  {% for provider, pdata in provider_data.items() %}
  <li class="nav-item" role="presentation">
    <button
      class="nav-link {% if provider == active_tab %}active{% endif %}"
      id="tab-{{ provider }}-btn"
      data-bs-toggle="tab"
      data-bs-target="#tab-{{ provider }}"
      data-provider="{{ provider }}"
      type="button"
      role="tab"
      aria-controls="tab-{{ provider }}"
      aria-selected="{{ 'true' if provider == active_tab else 'false' }}"
    >
      {% if provider == 'audible' %}
      <span class="badge text-bg-warning text-dark me-1">A</span>Audible
      {% elif provider == 'storytel' %}
      <span class="badge text-bg-info text-dark me-1">S</span>Storytel
      {% elif provider == 'open_library' %}
      <span class="badge text-bg-secondary me-1">OL</span>Open Library
      {% else %}
      {{ provider }}
      {% endif %}
      <span class="badge rounded-pill bg-secondary ms-1">{{ pdata.results|length }}</span>
    </button>
  </li>
  {% endfor %}
</ul>

<div class="tab-content" id="providerTabContent">
  {% for provider, pdata in provider_data.items() %}
  <div
    class="tab-pane fade {% if provider == active_tab %}show active{% endif %}"
    id="tab-{{ provider }}"
    role="tabpanel"
    aria-labelledby="tab-{{ provider }}-btn"
  >
    {{ result_cards(pdata, query, page, author_search, narrator_search, provider, provider_filter) }}
  </div>
  {% endfor %}
</div>

{% else %}

<!-- ── Single provider — no tab chrome ───────────────────────────────────────── -->
{% for provider, pdata in provider_data.items() %}{% if loop.first %}
{{ result_cards(pdata, query, page, author_search, narrator_search, '', provider_filter) }}
{% endif %}{% endfor %}

{% endif %}

{% else %}

<!-- ── No results ─────────────────────────────────────────────────────────────── -->
<div class="text-center text-muted py-5">
  <i class="bi bi-search display-4 d-block mb-3"></i>
  <p class="lead mb-1">No results found for &ldquo;<em>{{ query }}</em>&rdquo;</p>
  <p class="small">Try a different title, author name, or ISBN.</p>
</div>

{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Popovers for ABS match badges
document.querySelectorAll('[data-bs-toggle="popover"]').forEach(function (el) {
  new bootstrap.Popover(el, { html: false });
  el.addEventListener('shown.bs.popover', function () {
    document.addEventListener('click', function dismiss(e) {
      if (!el.contains(e.target)) {
        bootstrap.Popover.getInstance(el).hide();
        document.removeEventListener('click', dismiss);
      }
    });
  });
});

// Keep ?tab= in the URL when switching tabs so pagination links stay correct
document.querySelectorAll('#providerTabs button[data-provider]').forEach(function (btn) {
  btn.addEventListener('shown.bs.tab', function (e) {
    var provider = e.target.getAttribute('data-provider');
    var url = new URL(window.location);
    url.searchParams.set('tab', provider);
    url.searchParams.delete('page');
    history.replaceState(null, '', url.toString());
  });
});
</script>
{% endblock %}
