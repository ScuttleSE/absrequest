{% extends 'base.html' %}

{% block title %}Edit Request — ABS Request Manager{% endblock %}

{% block content %}
<div class="mb-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('manager.dashboard') }}">Manager Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('manager.requests_list') }}">Requests</a></li>
      <li class="breadcrumb-item active" aria-current="page">Edit #{{ req.id }}</li>
    </ol>
  </nav>
  <h2>Edit Request</h2>
</div>

<div class="row g-4">

  <!-- ── Left: book preview ─────────────────────────────────────────────────── -->
  <div class="col-lg-4">
    <div class="card shadow-sm">
      {% if req.cover_url %}
      <img
        src="{{ req.cover_url }}"
        alt="{{ req.title }}"
        class="card-img-top"
        style="max-height: 280px; object-fit: contain; background: #f8f9fa;"
      >
      {% else %}
      <div
        class="card-img-top d-flex align-items-center justify-content-center bg-light"
        style="height: 160px;"
      >
        <i class="bi bi-book display-3 text-muted"></i>
      </div>
      {% endif %}

      <div class="card-body">
        <h5 class="card-title mb-1">{{ req.title }}</h5>
        {% if req.author %}
        <p class="card-text mb-1 text-muted small">
          <i class="bi bi-person me-1"></i>{{ req.author }}
        </p>
        {% endif %}
        {% if req.narrator %}
        <p class="card-text mb-1 text-muted small">
          <i class="bi bi-mic me-1"></i>Narrated by {{ req.narrator }}
        </p>
        {% endif %}
        {% if req.duration %}
        <p class="card-text mb-1 text-muted small">
          <i class="bi bi-clock me-1"></i>{{ req.duration }}
        </p>
        {% endif %}
        {% if req.isbn %}
        <p class="card-text mb-0 text-muted small">
          <i class="bi bi-upc me-1"></i>ISBN {{ req.isbn }}
        </p>
        {% endif %}
      </div>

      <div class="card-footer text-muted small">
        <div>Requested by <strong>{{ req.user.name }}</strong></div>
        <div>{{ req.created_at.strftime('%Y-%m-%d %H:%M UTC') }}</div>
        {% if req.user_note %}
        <div class="mt-2 border-top pt-2">
          <div class="fw-semibold text-dark mb-1">User note:</div>
          <div>{{ req.user_note }}</div>
        </div>
        {% endif %}
      </div>
    </div>

    {% if req.abs_match_title %}
    <div class="card shadow-sm mt-3 border-info">
      <div class="card-body">
        <h6 class="card-title text-info">
          <i class="bi bi-collection me-1"></i>ABS Match
        </h6>
        <p class="mb-1 small"><strong>{{ req.abs_match_title }}</strong></p>
        {% if req.abs_match_author %}
        <p class="mb-0 small text-muted">{{ req.abs_match_author }}</p>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- ── Right: edit form ───────────────────────────────────────────────────── -->
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h4 class="card-title mb-4">
          <i class="bi bi-pencil-square me-2"></i>Update Status
        </h4>

        <form method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <!-- Status -->
          <div class="mb-4">
            <label for="status" class="form-label fw-semibold">Status</label>
            <select id="status" name="status" class="form-select">
              {% for key, cfg in STATUS_CONFIG.items() %}
              <option value="{{ key }}" {% if req.status == key %}selected{% endif %}>
                {{ cfg.label }}
              </option>
              {% endfor %}
            </select>
          </div>

          <!-- Manager note -->
          <div class="mb-4">
            <label for="manager_note" class="form-label fw-semibold">
              Manager Note
              <span class="fw-normal text-muted">(optional)</span>
            </label>
            <textarea
              id="manager_note"
              name="manager_note"
              class="form-control"
              rows="4"
              placeholder="Internal note visible to the requester and other managers…"
            >{{ req.manager_note or '' }}</textarea>
          </div>

          <!-- Actions -->
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-lg me-1"></i>Save Changes
            </button>
            <a
              href="{{ url_for('main.request_detail', request_id=req.id) }}"
              class="btn btn-outline-secondary"
              target="_blank"
            >
              <i class="bi bi-box-arrow-up-right me-1"></i>View as User
            </a>
            <a href="{{ url_for('manager.requests_list') }}" class="btn btn-outline-secondary">
              Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>
{% endblock %}
