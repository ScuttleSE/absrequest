{% extends 'base.html' %}

{% block title %}Users â€” ABS Request Manager{% endblock %}

{% block content %}
<div class="mb-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('manager.dashboard') }}">Manager Dashboard</a></li>
      <li class="breadcrumb-item active" aria-current="page">Users</li>
    </ol>
  </nav>
  <h2>Users</h2>
</div>

{% if users %}
<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Auth</th>
          <th>Registered</th>
          <th>Requests</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>
            {% if user.avatar_url %}
            <img
              src="{{ user.avatar_url }}"
              alt=""
              class="rounded-circle me-2"
              width="28"
              height="28"
              style="object-fit: cover;"
            >
            {% else %}
            <i class="bi bi-person-circle me-2 text-muted"></i>
            {% endif %}
            {{ user.name }}
            {% if user.id == current_user.id %}
            <span class="badge text-bg-light text-dark border ms-1">you</span>
            {% endif %}
          </td>
          <td>{{ user.email }}</td>
          <td>
            {% if user.is_manager %}
            <span class="badge text-bg-warning text-dark">
              <i class="bi bi-shield-check me-1"></i>Manager
            </span>
            {% else %}
            <span class="badge text-bg-secondary">User</span>
            {% endif %}
          </td>
          <td class="text-muted small">
            {% if user.oauth_provider %}
            <i class="bi bi-box-arrow-in-right me-1"></i>{{ user.oauth_provider | upper }}
            {% else %}
            <i class="bi bi-key me-1"></i>Local
            {% endif %}
          </td>
          <td class="text-muted small text-nowrap">
            {{ user.created_at.strftime('%Y-%m-%d') }}
          </td>
          <td class="text-muted small">
            {{ user.requests | length }}
          </td>
          <td>
            {% if user.id != current_user.id %}
            <form
              method="POST"
              action="{{ url_for('manager.toggle_user_role', user_id=user.id) }}"
              class="d-inline"
            >
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button
                type="submit"
                class="btn btn-sm {% if user.is_manager %}btn-outline-warning{% else %}btn-outline-secondary{% endif %}"
                onclick="return confirm('Change role for {{ user.name }}?')"
              >
                {% if user.is_manager %}
                <i class="bi bi-arrow-down-circle me-1"></i>Remove manager
                {% else %}
                <i class="bi bi-arrow-up-circle me-1"></i>Make manager
                {% endif %}
              </button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div class="text-center text-muted py-5 border rounded">
  <i class="bi bi-people display-4 d-block mb-3"></i>
  <p class="lead mb-0">No users found.</p>
</div>
{% endif %}
{% endblock %}
